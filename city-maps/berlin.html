<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Berlin City Map - Districts & Transportation</title>
    <meta
      name="description"
      content="Interactive Berlin city map with district information and public transportation routes"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Custom styles -->
    <link rel="stylesheet" href="../shared/css/base.css" />
    <link rel="stylesheet" href="../shared/css/components.css" />
    <link rel="stylesheet" href="../shared/css/map-common.css" />
    <link rel="stylesheet" href="css/city-maps.css" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  </head>

  <body>
    <!-- Main container -->
    <main class="map-container">
      <!-- Map Container -->
      <section class="map-section">
        <div class="custom-popup" id="map">
          <button class="transport-toggle" id="transportToggle">
            Ã–ffentliche Verkehrsmittel
          </button>
        </div>
      </section>
    </main>

    <!-- Loading indicator -->
    <div id="loading-indicator" class="loading-overlay" style="display: none">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p class="loading-text">Lade Kartendaten...</p>
      </div>
    </div>

    <!-- Scripts -->
    <!-- Leaflet JavaScript -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- Platform scripts -->
    <script src="../shared/js/env-loader.js"></script>
    <script src="../shared/js/map-utils.js"></script>
    <script src="../shared/js/map-base.js"></script>
    <script src="js/map-core.js"></script>
    <script src="js/city-map-factory.js"></script>

    <!-- Berlin city configuration -->
    <script src="config/berlin-city-config.js"></script>

    <!-- Application initialization -->
    <script>
      /**
       * Berlin City Map Application
       *
       * Now uses the new CityMapFactory for simplified initialization.
       * Creating new city maps is now as simple as swapping the configuration!
       */

      // Global variables
      let berlinCityMap;
      let loadingIndicator;

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        initializeBerlinCityMap();
      });

      /**
       * Initialize the Berlin city map application
       * Now dramatically simplified using the CityMapFactory!
       */
      async function initializeBerlinCityMap() {
        try {
          showLoading("Lade Konfiguration...");

          // Setup Google Sheets if API key is available
          await BerlinCityConfig.setupGoogleSheets();

          // Create the map
          berlinCityMap = await CityMapFactory.createCityMap(BerlinCityConfig, {
            showLoadingCallback: showLoading,
            hideLoadingCallback: hideLoading,
            setupResponsive: true,
            setupExternalEvents: true,
          });

          console.log("Berlin city map initialized successfully");
        } catch (error) {
          console.error("Failed to initialize Berlin city map:", error);
          hideLoading();
          MapUtils.handleError(error, "beim Initialisieren der Karte");
        }
      }

      /**
       * Show loading indicator
       */
      function showLoading(message = BerlinCityConfig.ui.loadingText) {
        if (!loadingIndicator) {
          loadingIndicator = document.getElementById("loading-indicator");
        }

        if (loadingIndicator) {
          const loadingText = loadingIndicator.querySelector(".loading-text");
          if (loadingText) {
            loadingText.textContent = message;
          }
          loadingIndicator.style.display = "flex";
        }
      }

      /**
       * Hide loading indicator
       */
      function hideLoading() {
        if (loadingIndicator) {
          loadingIndicator.style.display = "none";
        }
      }

      /**
       * Handle external map view changes (for WordPress integration)
       */
      function changeMapView(coordinates, zoom) {
        if (berlinCityMap && berlinCityMap.getMap()) {
          berlinCityMap.getMap().setView(coordinates, zoom);
        }
      }

      // Make functions available globally for external integration
      window.berlinCityMap = berlinCityMap;
      window.changeMapView = changeMapView;
    </script>
  </body>
</html>
